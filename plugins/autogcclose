import fs from 'fs';
import moment from 'moment-timezone';
import schedule from 'node-schedule';

const dbFile = './autoGC.json';
const timeZone = 'Africa/Casablanca';

// ØªØ¹Ø±ÙŠÙ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
global.autoGC = global.autoGC || {};

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù…Ù„Ù Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§
if (fs.existsSync(dbFile)) {
    global.autoGC = JSON.parse(fs.readFileSync(dbFile));
} else {
    fs.writeFileSync(dbFile, JSON.stringify({}, null, 2));
}

// ÙˆØ¸ÙŠÙØ© Ù„Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù…Ù„Ù
const saveDB = () => {
    try {
        fs.writeFileSync(dbFile, JSON.stringify(global.autoGC, null, 2));
        return true;
    } catch (err) {
        console.error('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', err);
        return false;
    }
};

// ÙˆØ¸ÙŠÙØ© Ù„ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª
const checkGroupsStatus = async () => {
    try {
        const currentTime = moment().tz(timeZone).format('HH:mm');
        for (const chatId in global.autoGC) {
            if (!global.autoGC[chatId]?.enabled) continue;
            const { closeTime, openTime, originalName, status } = global.autoGC[chatId];

            if (currentTime === closeTime && status !== 'closed') {
                try {
                    await conn.groupSettingUpdate(chatId, 'announcement');
                    await conn.groupUpdateSubject(chatId, `${originalName} (âŒ Ù…ØºÙ„Ù‚)`);
                    await conn.sendMessage(chatId, { text: `ğŸš« * ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø¤Ù‚ØªÙ‹Ø§ Ø¯Ø§Ø¦Ù…Ø§ Ø¥Ù‚Ø±Ø¤Ø§ Ù‚ÙˆØ§Ù†ÙŠÙ† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø­ØªÙ‰ Ù„Ø§ ÙŠØªÙ… Ø·Ø±Ø¯ÙƒÙ…* ğŸš«\n\nØ³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ÙØªØ­Ù‡Ø§ ÙÙŠ *${openTime}*.` });
                    global.autoGC[chatId].status = 'closed';
                    saveDB();
                } catch (e) {
                    console.error(`Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© ${chatId}:`, e);
                }
            }

            if (currentTime === openTime && status !== 'opened') {
                try {
                    await conn.groupSettingUpdate(chatId, 'not_announcement');
                    await conn.groupUpdateSubject(chatId, originalName);
                    await conn.sendMessage(chatId, { text: `âœ… *ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ÙØªØ­ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ø³ØªÙ…ØªØ¹ÙˆØ§ Ø¨Ù…Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø¨ÙˆØª Ùˆ Ø§Ù‚Ø±Ø¤ÙˆØ§ Ù‚ÙˆØ§Ù†ÙŠÙ† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ù„Ø£Ù† Ù†ÙˆØ± Ø§Ù„Ø¯ÙŠÙ† Ù„Ø§ ÙŠØªÙ‡Ø§ÙˆÙ† Ù…Ø¹ Ù…Ù† ÙŠØ®Ø§Ù„ÙÙ‡Ø§* âœ…\n\nÙˆÙ‚Øª Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ§Ù„ÙŠ: *${closeTime}*.` });
                    global.autoGC[chatId].status = 'opened';
                    saveDB();
                } catch (e) {
                    console.error(`Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ÙØªØ­ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© ${chatId}:`, e);
                }
            }
        }
    } catch (err) {
        console.error('Ø®Ø·Ø£ ÙÙŠ checkGroupsStatus:', err);
    }
};

// Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„ÙØ­Øµ ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø©
if (!global.autoGCSchedule) {
    global.autoGCSchedule = schedule.scheduleJob('* * * * *', () => {
        checkGroupsStatus().catch(err => console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø©:', err));
    });
    console.log('ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª');
}

const handler = async (m, { conn, args }) => {
    const chatId = m.chat;
    if (!m.isGroup) return m.reply('âŒ Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø± ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª!');

    let groupMetadata;
    try {
        groupMetadata = await conn.groupMetadata(chatId);
    } catch (err) {
        console.error('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©:', err);
        return m.reply('âŒ ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©.');
    }

    const sender = m.sender;
    const isAdmin = groupMetadata.participants.some(participant =>
        participant.id === sender && (participant.admin === 'admin' || participant.admin === 'superadmin'));

    if (!isAdmin) return m.reply('âŒ Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø± Ù…ØªØ§Ø­ ÙÙ‚Ø· Ù„Ù…Ø´Ø±ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©.');

    if (args[0]?.toLowerCase() === 'on') {
        global.autoGC[chatId] = {
            enabled: true,
            closeTime: global.autoGC[chatId]?.closeTime || '22:00',
            openTime: global.autoGC[chatId]?.openTime || '10:00',
            originalName: groupMetadata.subject,
            status: 'opened'
        };
        return saveDB()
            ? m.reply(`âœ… ØªÙ… *ØªÙØ¹ÙŠÙ„* Ø§Ù„Ø¥ØºÙ„Ø§Ù‚/Ø§Ù„ÙØªØ­ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ.\n\nğŸ“Œ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚: ${global.autoGC[chatId].closeTime}\nğŸ“Œ Ø§Ù„ÙØªØ­: ${global.autoGC[chatId].openTime}`)
            : m.reply('âŒ ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.');
    }

    if (args[0]?.toLowerCase() === 'off') {
        if (!global.autoGC[chatId]?.enabled) return m.reply('âš ï¸ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚/Ø§Ù„ÙØªØ­ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…ÙØ¹Ø·Ù„ Ø¨Ø§Ù„ÙØ¹Ù„.');
        delete global.autoGC[chatId];
        return saveDB() ? m.reply('âŒ ØªÙ… *Ø¥Ù„ØºØ§Ø¡* ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚/Ø§Ù„ÙØªØ­ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ.') : m.reply('âŒ ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.');
    }

    if (args[0]?.toLowerCase() === 'set' && args[1] && args[2]) {
        if (!/^([01]\d|2[0-3]):([0-5]\d)$/.test(args[1]) || !/^([01]\d|2[0-3]):([0-5]\d)$/.test(args[2])) {
            return m.reply('âš ï¸ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª ØºÙŠØ± ØµØ­ÙŠØ­! Ø§Ø³ØªØ®Ø¯Ù… HH:MM Ø¨Ù†Ø¸Ø§Ù… 24 Ø³Ø§Ø¹Ø©.');
        }
        global.autoGC[chatId] = {
            enabled: true,
            closeTime: args[1],
            openTime: args[2],
            originalName: groupMetadata.subject,
            status: 'opened'
        };
        return saveDB()
            ? m.reply(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø©.\nğŸ“Œ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚: ${args[1]}\nğŸ“Œ Ø§Ù„ÙØªØ­: ${args[2]}`)
            : m.reply('âŒ ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.');
    }

    if (args[0]?.toLowerCase() === 'status') {
        if (!global.autoGC[chatId]) return m.reply('âš ï¸ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚/Ø§Ù„ÙØªØ­ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ØºÙŠØ± Ù…ÙØ¹Ù„.');
        const { enabled, closeTime, openTime, status } = global.autoGC[chatId];
        return m.reply(`ğŸ“Š *Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©*\n\n` +
            `Ø§Ù„Ø­Ø§Ù„Ø©: ${enabled ? 'âœ… Ù…ÙØ¹Ù„' : 'âŒ Ù…Ø¹Ø·Ù„'}\n` +
            `Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©: ${status === 'closed' ? 'ğŸ”’ Ù…ØºÙ„Ù‚Ø©' : 'ğŸ”“ Ù…ÙØªÙˆØ­Ø©'}\n` +
            `Ø§Ù„Ø¥ØºÙ„Ø§Ù‚: ${closeTime}\nØ§Ù„ÙØªØ­: ${openTime}`);
    }

    return m.reply('âš ï¸ ØªÙ†Ø³ÙŠÙ‚ ØºÙŠØ± ØµØ­ÙŠØ­! Ø§Ø³ØªØ®Ø¯Ù…:\n- auto on\n- auto off\n- auto set HH:MM HH:MM\n- auto status');
};

handler.command = ['auto'];
handler.owner = true 
export default handler;
